<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Title</title>
  </head>
  <body>
    static

    <script>
      const query = Object.fromEntries(
        window.location.search
          .substr(1)
          .split("&")
          .map((group) => group.split("="))
      );
      console.log(query);
      const channelNames = (query["channels"] || "").split(",");
      console.log(channelNames);

      const channels = {};
      for (const channelName of channelNames) {
        channels[channelName.toLowerCase()] = false;
      }

      // TODO: ローカルで動くようにする
      const sock = new WebSocket("wss://" + window.location.host + "/ws");

      sock.addEventListener("open", () => {
        console.log("ws connected");
      });

      sock.addEventListener("message", (e) => {
        if (e.data === "pong") {
          console.log(e.data);
          return;
        }

        const data = JSON.parse(e.data);
        console.log(data);

        if (data.type === "stream.online") {
          channels[data.channel.toLowerCase()] = true;
        }
        if (data.type === "stream.offline") {
          channels[data.channel.toLowerCase()] = false;
        }
        console.log("channels:", channels);
      });

      setInterval(() => {
        sock.send("ping");
      }, 10000);

      const xhr = new XMLHttpRequest();

      xhr.open("POST", "/api/subscriptions");
      xhr.setRequestHeader("Content-Type", "application/json");

      xhr.onerror = (e) => {
        console.log(e);
      };
      xhr.onload = () => {
        console.log(xhr.response);
      };
      xhr.send(JSON.stringify({ channels: channelNames }));

      const xhr2 = new XMLHttpRequest();
      const names = channelNames
        .map((channelName) => "names[]=" + channelName)
        .join("&");
      xhr2.open("GET", "/api/channels/search?" + names);
      xhr2.onerror = (e) => {
        console.log(e);
      };
      xhr2.onload = () => {
        console.log(xhr2.responseText);
        for (const ch of JSON.parse(xhr2.responseText).data) {
          channels[ch.name.toLowerCase()] = ch.isLive;
        }
        console.log("channels(initial):", channels);
      };
      xhr2.send();
    </script>
  </body>
</html>
